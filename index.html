<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Ops - COA Integrated</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    * { box-sizing: border-box; }
    .staff-container { width: 100%; padding: 20px; max-width: 800px; margin: 0 auto; }
    .header { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .header h1 { margin: 0 0 8px 0; color: #1a202c; font-size: 24px; font-weight: 700; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { flex: 1; min-width: 100px; padding: 12px; background: white; border-radius: 10px; font-weight: 600; color: #4a5568; transition: all 0.2s; }
    .tab-btn.active { background: #34d399; color: white; box-shadow: 0 4px 10px rgba(52, 211, 153, 0.3); }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .form-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
    .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; font-size: 15px; outline: none; transition: border 0.2s; }
    .input-field:focus { border-color: #667eea; }
    
    /* Section Headers */
    .section-title { font-size: 14px; font-weight: 800; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 12px; margin-top: 16px; }

    /* Calculator */
    .calculator-box { background: #f8fafc; padding: 16px; border-radius: 12px; border-left: 4px solid #667eea; margin: 20px 0; }
    .calc-row { display: flex; justify-content: space-between; font-size: 13px; color: #64748b; margin-bottom: 6px; }
    .calc-row.total { font-size: 16px; font-weight: 800; color: #1e293b; border-top: 2px dashed #cbd5e0; padding-top: 10px; margin-top: 8px; }

    /* Expense List */
    .expense-list { margin-top: 10px; background: #fff1f2; border-radius: 8px; overflow: hidden; border: 1px solid #fecdd3; }
    .expense-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #fecdd3; font-size: 13px; color: #be123c; }
    
    .submit-btn { width: 100%; padding: 16px; background: #10b981; color: white; border-radius: 12px; font-weight: 700; margin-top: 10px; transition: transform 0.2s; }
    .submit-btn:hover { transform: translateY(-2px); background: #059669; }
    .submit-btn:disabled { background: #cbd5e0; transform: none; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: #1e293b; color: white; padding: 14px 24px; border-radius: 10px; display: none; z-index: 50; }
    .toast.show { display: block; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* New Service Grid */
    .service-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
    .service-label { font-weight: 800; font-size: 13px; color: #4f46e5; margin-bottom: 8px; display: block; }
    .sub-label { font-size: 10px; color: #94a3b8; font-weight: 700; margin-bottom: 2px; }
  </style>
 </head>
 <body>

  <div class="staff-container">
   <header class="header">
    <h1>üë®‚Äçüç≥ PayBoss Staff Ops</h1>
    <p class="text-sm text-gray-500">Input Data Terintegrasi (COA Ready)</p>
   </header>

   <div class="tabs">
    <button class="tab-btn active" data-tab="kas">üíµ Kas &amp; Shift</button>
    <button class="tab-btn" data-tab="dapur">üì¶ Stok Dapur</button>
    <button class="tab-btn" data-tab="bar">üç∑ Stok Bar</button>
   </div>

   <!-- 1. KAS & SHIFT -->
   <div class="tab-content active" id="kas-tab">
    <div class="form-card">
     <div id="current-shift-badge" class="mb-4"></div>
     
     <form id="kasForm">
      <div class="grid grid-cols-2 gap-3">
       <div class="form-group col-span-2">
        <label>Nama Staff (Kasir)</label>
        <select id="kas-staff" class="input-field" required><option value="">-- Pilih Nama --</option></select>
       </div>
       <div class="form-group col-span-2">
        <label>Modal Awal (Rp)</label>
        <input type="number" id="modal-awal" class="input-field" placeholder="0" required>
       </div>
      </div>

      <!-- A. PENDAPATAN F&B -->
      <div class="section-title">A. Pendapatan F&B (Utama)</div>
      <div class="grid grid-cols-2 gap-3">
       <div class="form-group">
        <label>Penjualan QRIS</label>
        <input type="number" id="penjualan-qris" class="input-field bg-slate-50" placeholder="0">
       </div>
       <div class="form-group">
        <label>Penjualan Tunai</label>
        <input type="number" id="penjualan-cash" class="input-field bg-slate-50" placeholder="0">
       </div>
      </div>

      <!-- B. PENDAPATAN JASA LAIN -->
      <div class="section-title">B. Pendapatan Jasa Lain (Non-F&B)</div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- Karaoke -->
          <div class="service-card">
              <span class="service-label">üé§ Karaoke</span>
              <div class="grid grid-cols-2 gap-2">
                  <div><label class="sub-label">Tunai</label><input type="number" id="kar-cash" class="input-field text-sm" placeholder="0"></div>
                  <div><label class="sub-label">QRIS</label><input type="number" id="kar-qris" class="input-field text-sm" placeholder="0"></div>
              </div>
          </div>

          <!-- Billiard -->
          <div class="service-card">
              <span class="service-label">üé± Billiard</span>
              <div class="grid grid-cols-2 gap-2">
                  <div><label class="sub-label">Tunai</label><input type="number" id="bil-cash" class="input-field text-sm" placeholder="0"></div>
                  <div><label class="sub-label">QRIS</label><input type="number" id="bil-qris" class="input-field text-sm" placeholder="0"></div>
              </div>
          </div>

          <!-- Hipnoterapi -->
          <div class="service-card">
              <span class="service-label">üß† Hipnoterapi</span>
              <div class="grid grid-cols-2 gap-2">
                  <div><label class="sub-label">Tunai</label><input type="number" id="hyp-cash" class="input-field text-sm" placeholder="0"></div>
                  <div><label class="sub-label">QRIS</label><input type="number" id="hyp-qris" class="input-field text-sm" placeholder="0"></div>
              </div>
          </div>

          <!-- Kursi Pijat -->
          <div class="service-card">
              <span class="service-label">üíÜ Kursi Pijat</span>
              <div class="grid grid-cols-2 gap-2">
                  <div><label class="sub-label">Tunai</label><input type="number" id="mas-cash" class="input-field text-sm" placeholder="0"></div>
                  <div><label class="sub-label">QRIS</label><input type="number" id="mas-qris" class="input-field text-sm" placeholder="0"></div>
              </div>
          </div>
      </div>

      <!-- C. PENGELUARAN -->
      <div class="section-title text-rose-600 border-rose-100">C. Pengeluaran Operasional (Cash Out)</div>
      <div class="bg-rose-50 p-3 rounded-lg border border-rose-100 mb-4">
        <div class="grid grid-cols-1 gap-2 mb-2">
            <select id="exp-category" class="input-field text-sm bg-white">
                <option value="">-- Pilih Kategori Pengeluaran --</option>
                <option value="5101">üõí Bahan Baku (Es/Galon/Sayur)</option>
                <option value="5302">üî• Gas & Air</option>
                <option value="5304">üßπ Kebersihan (Sabun/Tisu)</option>
                <option value="5404">üõµ Transport / Bensin</option>
                <option value="prive">üíº Setor ke Owner/Bos (Prive)</option>
                <option value="lain">üìù Lain-lain</option>
            </select>
            <div class="flex gap-2">
                <input type="text" id="exp-desc" class="input-field text-sm" placeholder="Keterangan (Wajib)" style="flex:2">
                <input type="number" id="exp-amt" class="input-field text-sm" placeholder="Rp" style="flex:1">
            </div>
        </div>
        <button type="button" onclick="addExpense()" class="w-full bg-rose-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-rose-700">+ Tambah Item</button>
        <div id="expense-list-container" class="expense-list hidden"></div>
        <input type="hidden" id="total-expenses" value="0">
      </div>

      <!-- Kalkulator -->
      <div class="calculator-box">
       <div class="calc-row"><span>Modal Awal</span> <strong id="calc-modal">Rp 0</strong></div>
       <div class="calc-row"><span>Total Tunai Masuk (F&B + Jasa)</span> <strong id="calc-total-in">Rp 0</strong></div>
       <div class="calc-row text-rose-600"><span>Total Pengeluaran</span> <strong id="calc-exp">- Rp 0</strong></div>
       <div class="calc-row total"><span>Uang Fisik Seharusnya</span> <strong id="calc-total">Rp 0</strong></div>
      </div>

      <!-- Fisik -->
      <div class="form-group">
          <label class="text-emerald-700">Hitung Uang Fisik Di Laci (Wajib)</label>
          <input type="number" id="fisik-laci" class="input-field border-emerald-500 bg-emerald-50 text-lg font-bold" required placeholder="0">
      </div>

      <div class="form-group mt-3">
        <label>Catatan Shift</label>
        <textarea id="shift-notes" rows="2" class="input-field text-sm" placeholder="Ada selisih? Catat di sini..."></textarea>
      </div>

      <button type="submit" id="kas-submit-btn" class="submit-btn">üíæ Simpan Laporan Shift</button>
     </form>
    </div>

    <!-- History -->
    <div class="bg-white p-4 rounded-xl shadow-sm">
        <h3 class="font-bold text-slate-700 mb-2">Riwayat Hari Ini</h3>
        <div id="kas-history" class="space-y-2 text-sm text-slate-500 text-center italic">Memuat data...</div>
    </div>
   </div>

   <!-- 2. STOK DAPUR -->
   <div class="tab-content" id="dapur-tab">
    <div class="form-card">
     <div class="section-title">Update Stok Dapur</div>
     <form id="dapurForm">
      <div class="form-group"><label>Chef/Koki</label><select id="dapur-staff" class="input-field" required><option value="">-- Pilih --</option></select></div>
      <div class="form-group"><label>Barang</label><input type="text" id="dapur-item" list="dapur-items" class="input-field" required><datalist id="dapur-items"></datalist></div>
      <div class="flex gap-2">
          <div class="form-group flex-1"><label>Jumlah</label><input type="number" id="dapur-qty" class="input-field" required></div>
          <div class="form-group flex-1"><label>Aksi</label><select id="dapur-movement" class="input-field" required><option value="masuk">Masuk (+)</option><option value="keluar">Keluar (-)</option></select></div>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('dapur','Beras')">Beras</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('dapur','Minyak')">Minyak</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('dapur','Telur')">Telur</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('dapur','Ayam')">Ayam</button>
      </div>
      <button type="submit" id="dapur-submit-btn" class="submit-btn bg-blue-600 hover:bg-blue-700">Update Stok</button>
     </form>
    </div>
    <div id="dapur-stock-list" class="grid grid-cols-2 gap-3"></div>
   </div>

   <!-- 3. STOK BAR -->
   <div class="tab-content" id="bar-tab">
    <div class="form-card">
     <div class="section-title">Update Stok Bar</div>
     <form id="barForm">
      <div class="form-group"><label>Barista</label><select id="bar-staff" class="input-field" required><option value="">-- Pilih --</option></select></div>
      <div class="form-group"><label>Barang</label><input type="text" id="bar-item" list="bar-items" class="input-field" required><datalist id="bar-items"></datalist></div>
      <div class="flex gap-2">
          <div class="form-group flex-1"><label>Jumlah</label><input type="number" id="bar-qty" class="input-field" required></div>
          <div class="form-group flex-1"><label>Aksi</label><select id="bar-movement" class="input-field" required><option value="masuk">Masuk (+)</option><option value="keluar">Keluar (-)</option></select></div>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('bar','Kopi Bubuk')">Kopi</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('bar','Susu UHT')">Susu</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('bar','Sirup')">Sirup</button>
        <button type="button" class="px-3 py-1 bg-slate-100 rounded text-xs" onclick="quickFill('bar','Es Batu')">Es Batu</button>
      </div>
      <button type="submit" id="bar-submit-btn" class="submit-btn bg-purple-600 hover:bg-purple-700">Update Stok</button>
     </form>
    </div>
    <div id="bar-stock-list" class="grid grid-cols-2 gap-3"></div>
   </div>

  </div>
  <div id="toast" class="toast">Notif</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const getColRef = (name) => collection(db, name);

    // --- DATA STAFF ---
    const staffList = [
        { name: "Muhammad Fir Nando", role: "Pramusaji" }, { name: "Muhammad Zikrillah", role: "Pramusaji" },
        { name: "Renita Aulia Jasmin", role: "Bartender" }, { name: "Rifky Arya Ramadhani", role: "Pramusaji" },
        { name: "Ahmad Maulidan Noor", role: "Bartender" }, { name: "Rusdhani", role: "Pramusaji" },
        { name: "Fitri Ainur Sabita", role: "Chef" }, { name: "Shada Amalia", role: "Chef" },
        { name: "Ovy Putri Novia", role: "Chef" }, { name: "Jihan Permata Sari", role: "Kasir" },
        { name: "Samlawi", role: "Bartender" }, { name: "Iqbal Arasyid", role: "Chef" },
        { name: "Ansyari Fachmi Ridhani", role: "Bartender" }, { name: "Farah Asyifa ", role: "Kasir" },
        { name: "Nahjatus Sabela", role: "Kasir" }, { name: "Alif Junifa", role: "Chef" }
    ];

    let expenseList = [];

    // --- INIT ---
    function init() {
        populateStaff();
        loadHistory();
        loadStock('inventory_kitchen', 'dapur-stock-list', 'dapur-items');
        loadStock('inventory_bar', 'bar-stock-list', 'bar-items');
    }

    const initAuth = async () => { try { await signInAnonymously(auth); } catch(e){} init(); };
    initAuth();
    onAuthStateChanged(auth, (u) => { if(u) init(); });

    function populateStaff() {
        const fill = (id, role) => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">-- Pilih --</option>';
            staffList.filter(s => s.role === role).forEach(s => el.innerHTML += `<option value="${s.name}">${s.name}</option>`);
            el.innerHTML += '<option value="Lainnya">Lainnya</option>';
        };
        fill('kas-staff', 'Kasir');
        fill('dapur-staff', 'Chef');
        fill('bar-staff', 'Bartender');
    }

    // --- LOGIC SHIFT ---
    function getShift() {
        const h = new Date().getHours();
        const badge = document.getElementById('current-shift-badge');
        let s = '', c = '';
        if (h >= 0 && h < 8) { s = 'Pagi'; c = 'bg-yellow-100 text-yellow-800'; }
        else if (h >= 8 && h < 16) { s = 'Siang'; c = 'bg-emerald-100 text-emerald-800'; }
        else { s = 'Malam'; c = 'bg-purple-100 text-purple-800'; }
        
        if(badge) badge.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-bold ${c}">Shift ${s} Aktif (${h}:00)</span>`;
        return s;
    }
    getShift(); setInterval(getShift, 60000);

    function getOpDate() {
        const d = new Date();
        // Shift Pagi (00-08) tetap dihitung hari ini (Tidak mundur hari)
        return d.toLocaleDateString('id-ID');
    }

    // --- EXPENSES & CALCULATOR ---
    window.addExpense = () => {
        const catEl = document.getElementById('exp-category');
        const desc = document.getElementById('exp-desc').value;
        const amt = parseInt(document.getElementById('exp-amt').value) || 0;
        
        if(!catEl.value || !desc || amt <= 0) { showToast('Lengkapi data pengeluaran!'); return; }
        
        const catName = catEl.options[catEl.selectedIndex].text;
        expenseList.push({ categoryCode: catEl.value, categoryName: catName, desc, amount: amt });
        
        renderExp();
        document.getElementById('exp-desc').value = '';
        document.getElementById('exp-amt').value = '';
    }

    window.removeExpense = (i) => { expenseList.splice(i, 1); renderExp(); }

    function renderExp() {
        const con = document.getElementById('expense-list-container');
        const totalInput = document.getElementById('total-expenses');
        con.innerHTML = '';
        let total = 0;
        
        expenseList.forEach((e, i) => {
            total += e.amount;
            con.innerHTML += `<div class="expense-item"><span>[${e.categoryName}] ${e.desc}</span><span>${fmt(e.amount)} <b onclick="removeExpense(${i})" class="ml-2 cursor-pointer text-red-500">x</b></span></div>`;
        });
        
        con.classList.toggle('hidden', expenseList.length === 0);
        totalInput.value = total;
        calc();
    }

    function calc() {
        const modal = parseInt(document.getElementById('modal-awal').value) || 0;
        const fnbCash = parseInt(document.getElementById('penjualan-cash').value) || 0;
        
        // JASA LAIN (TUNAI ONLY yang dihitung ke fisik)
        const karCash = parseInt(document.getElementById('kar-cash').value) || 0;
        const bilCash = parseInt(document.getElementById('bil-cash').value) || 0;
        const hypCash = parseInt(document.getElementById('hyp-cash').value) || 0;
        const masCash = parseInt(document.getElementById('mas-cash').value) || 0;
        
        const totalServiceCash = karCash + bilCash + hypCash + masCash;
        const exp = parseInt(document.getElementById('total-expenses').value) || 0;
        
        // Rumus: Modal + F&B Tunai + Jasa Tunai - Pengeluaran
        const total = modal + fnbCash + totalServiceCash - exp;

        document.getElementById('calc-modal').innerText = fmt(modal);
        document.getElementById('calc-fnb').innerText = fmt(fnbCash);
        document.getElementById('calc-services').innerText = fmt(totalServiceCash);
        document.getElementById('calc-exp').innerText = "- " + fmt(exp);
        document.getElementById('calc-total').innerText = fmt(total);
    }

    // Attach listeners to all inputs
    const ids = ['modal-awal', 'penjualan-cash', 'kar-cash', 'bil-cash', 'hyp-cash', 'mas-cash'];
    ids.forEach(id => document.getElementById(id)?.addEventListener('input', calc));

    // --- SUBMIT SHIFT ---
    document.getElementById('kasForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('kas-submit-btn');
        btn.disabled = true; btn.innerText = 'Menyimpan...';

        try {
            const modal = parseInt(document.getElementById('modal-awal').value) || 0;
            
            // F&B
            const fnbCash = parseInt(document.getElementById('penjualan-cash').value) || 0;
            const fnbQris = parseInt(document.getElementById('penjualan-qris').value) || 0;

            // Services
            const karCash = parseInt(document.getElementById('kar-cash').value) || 0;
            const karQris = parseInt(document.getElementById('kar-qris').value) || 0;
            
            const bilCash = parseInt(document.getElementById('bil-cash').value) || 0;
            const bilQris = parseInt(document.getElementById('bil-qris').value) || 0;
            
            const hypCash = parseInt(document.getElementById('hyp-cash').value) || 0;
            const hypQris = parseInt(document.getElementById('hyp-qris').value) || 0;
            
            const masCash = parseInt(document.getElementById('mas-cash').value) || 0;
            const masQris = parseInt(document.getElementById('mas-qris').value) || 0;

            // Totals
            const totalCashIn = fnbCash + karCash + bilCash + hypCash + masCash;
            const totalQrisIn = fnbQris + karQris + bilQris + hypQris + masQris;
            const exp = parseInt(document.getElementById('total-expenses').value) || 0;
            const fisik = parseInt(document.getElementById('fisik-laci').value) || 0;
            const expected = modal + totalCashIn - exp;

            await addDoc(getColRef('shift_reports'), {
                staffName: document.getElementById('kas-staff').value,
                shift: getShift(),
                date: getOpDate(),
                realDate: new Date().toISOString(),
                
                // Financial Data (Aggregated for Manager)
                startCash: modal,
                cashSales: totalCashIn,
                qrisSales: totalQrisIn,
                
                // Detail Services Income
                incomeFnbCash: fnbCash, incomeFnbQris: fnbQris,
                incomeKaraokeCash: karCash, incomeKaraokeQris: karQris,
                incomeBilliardCash: bilCash, incomeBilliardQris: bilQris,
                incomeHypnoCash: hypCash, incomeHypnoQris: hypQris,
                incomeMassageCash: masCash, incomeMassageQris: masQris,

                // Legacy Fields for Backward Compatibility
                incomeKaraoke: karCash + karQris,
                incomeMassage: masCash + masQris,
                incomeHypno: hypCash + hypQris,

                expenses: exp,
                expenseDetails: expenseList,
                expectedCash: expected,
                physicalCash: fisik,
                difference: fisik - expected,
                notes: document.getElementById('shift-notes').value,
                timestamp: serverTimestamp(),
                createdAt: serverTimestamp()
            });

            showToast('Laporan Shift Tersimpan!');
            setTimeout(() => location.reload(), 1500);
        } catch(err) { console.error(err); showToast('Gagal menyimpan: ' + err.message); btn.disabled = false; }
    });

    // --- HISTORY ---
    function loadHistory() {
        try {
            const q = query(getColRef("shift_reports"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const con = document.getElementById('kas-history');
                const today = getOpDate();
                const logs = snap.docs.map(d => d.data()).filter(d => d.date === today);
                
                if(!logs.length) { con.innerHTML = '<div class="text-center italic text-gray-400">Belum ada data hari ini</div>'; return; }
                
                con.innerHTML = logs.map(l => `
                    <div class="flex justify-between p-3 bg-slate-50 rounded border-l-4 border-emerald-500 mb-2">
                        <div>
                            <div class="font-bold text-slate-700">${l.staffName} <span class="font-normal text-xs text-slate-500">(${l.shift})</span></div>
                            <div class="text-xs text-slate-500">Fisik: ${fmt(l.physicalCash)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">Selisih</div>
                            <div class="font-bold ${l.difference < 0 ? 'text-red-500' : 'text-emerald-600'}">${l.difference > 0 ? '+' : ''}${fmt(l.difference)}</div>
                        </div>
                    </div>
                `).join('');
            }, (error) => {
                console.warn("History denied:", error.message);
                document.getElementById('kas-history').innerHTML = '<div class="text-center text-red-400 text-xs py-2">Gagal memuat riwayat (Cek Rules)</div>';
            });
        } catch(e){}
    }

    // --- INVENTORY ---
    const handleStock = async (e, type) => {
        e.preventDefault();
        const coll = type === 'dapur' ? 'inventory_kitchen' : 'inventory_bar';
        const staff = document.getElementById(`${type}-staff`).value;
        const item = document.getElementById(`${type}-item`).value;
        const qty = parseInt(document.getElementById(`${type}-qty`).value) || 0;
        const move = document.getElementById(`${type}-movement`).value;
        const btn = document.getElementById(`${type}-submit-btn`);

        if(!staff || !item || qty <= 0) return;
        btn.disabled = true; btn.innerText = '...';

        try {
            const q = query(getColRef(coll), where('name', '==', item));
            const snap = await getDocs(q);
            if(!snap.empty) {
                const docId = snap.docs[0].id;
                const cur = snap.docs[0].data().stock || 0;
                await updateDoc(doc(db, coll, docId), { stock: move==='masuk' ? cur+qty : cur-qty, lastUpdate: serverTimestamp(), lastUser: staff });
            } else {
                await addDoc(getColRef(coll), { name: item, stock: move==='masuk' ? qty : 0, unit: 'pcs', lastUpdate: serverTimestamp(), lastUser: staff });
            }
            showToast('Stok Diupdate!');
            document.getElementById(`${type}Form`).reset();
        } catch(e) { showToast('Gagal update'); }
        finally { btn.disabled = false; btn.innerText = 'Update Stok'; }
    };
    document.getElementById('dapurForm').addEventListener('submit', e => handleStock(e, 'dapur'));
    document.getElementById('barForm').addEventListener('submit', e => handleStock(e, 'bar'));

    function loadStock(coll, listId, dataId) {
        onSnapshot(query(getColRef(coll), orderBy("name")), (snap) => {
            const con = document.getElementById(listId);
            const dl = document.getElementById(dataId);
            const items = snap.docs.map(d => d.data());
            dl.innerHTML = items.map(i => `<option value="${i.name}">`).join('');
            con.innerHTML = items.map(i => `
                <div class="bg-white p-3 rounded border border-slate-200 text-center">
                    <div class="font-bold text-slate-700 text-sm truncate">${i.name}</div>
                    <div class="text-xl font-bold text-emerald-600">${i.stock}</div>
                    <div class="text-[10px] text-slate-400 mt-1">${i.lastUser||'-'}</div>
                </div>
            `).join('');
        }, (error) => {
            console.warn("Stock denied:", error.message);
            document.getElementById(listId).innerHTML = '<div class="col-span-2 text-center text-red-400 text-xs">Gagal memuat stok</div>';
        });
    }

    // --- UTILS ---
    window.quickFill = (t, v) => { document.getElementById(`${t}-item`).value = v; document.getElementById(`${t}-qty`).focus(); };
    function fmt(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
    
    // Tab
    document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        document.getElementById(`${b.dataset.tab}-tab`).classList.add('active');
    }));
  </script>
 </body>
</html>
